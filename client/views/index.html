<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Woodpecker puzzle</title>
    <link rel="stylesheet" type="text/css" href="css/chessground.base.css">
    <link rel="stylesheet" type="text/css" href="css/chessground.brown.css">
    <link rel="stylesheet" type="text/css" href="css/chessground.cburnett.css">
    <style>
        #chessground {
            width: 700px;
            height: 700px;
        }

        cg-board {
            background-color: #e9d5b0

        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <script type="module">
        setIdGui()
        import { Chessground } from '/js/chessground.js';
        import { Chess } from '/js/chess.js'
        import { config } from '/js/groundConfig.js'
        import { playMoveSound, shuffle, getCookie, setCookie } from '/js/helpers.js'
        import player from './js/index.js';
        import { getPuzzle, getHundredPuzzleIds } from '/js/client.js'
        
        var ids = await getHundredPuzzleIds() ?? ['00008']
        ids = shuffle(ids)
        var $score = $('#score')
        var score = 0
        var puzzles = []
        var fen  = null
        var moves = null
        var game  = null
        var ground  = null
        ground = Chessground(document.getElementById('chessground'), config)

        await initGame()
        async function queuePuzzles(cnt, max){
            if (puzzles.length > max) return
            for (var i =0; i < cnt; i++){
                var id = ids.shift()
                if (id != undefined){
                    var puzzle = await getPuzzle(id)
                    puzzles.push(puzzle)
                    console.log(' Queued puzzles: ' + puzzles.length)
                }
            }
        }

        async function initGame(){
            if (puzzles.length == 0){
                var puzzle = await getPuzzle(ids.shift())
                puzzles.push(puzzle)
                console.log('waiting for puzzle')
            }
            puzzle = puzzles.shift()
            fen = puzzle.Fen
            config.fen= fen
            moves = puzzle.Moves
            game = new Chess(fen)
            console.log(fen)
            var nextMoveTurn = game.turn() == 'w' ? 'black' : 'white'
            config.turnColor =  nextMoveTurn
            config.movable.color = nextMoveTurn
            config.orientation = nextMoveTurn
            ground.set(config)
            movePiece(moves.shift())
            if (ids.length < 10){
                var newIds =  await getHundredPuzzleIds()
                ids = ids.concat(newIds)
            }
            queuePuzzles(5,10)
        }

        function checkLegality(source, desct, capturedPiece){
            console.log(source + ' to ' + desct)
            var fenBeforeMove = game.fen()
            
            var move = game.move({
                from: source,
                to: desct.substr(0,2),
                promotion: desct.substr(2,1) ?? 'q' // promote to queen if all else fails
            })
            // illegal move
            if (move === null){
                config.fen = fenBeforeMove
                config.lastMove = undefined
                ground.set(config)
                playMoveSound(move, capturedPiece.captured)
                return false
            }
            playMoveSound(move, capturedPiece.captured)
            return true
        }

        function onInsert(){
            // console.log('onInsert')
        }
        function onSelect(key){
            // console.log('onSelect') 
        }
        function ondropNewPiece(){
            //  console.log('ondropNewPiece')
        }
        function onafterNewPiece(){
            //  console.log('onafterNewPiece')
        }
        function onChange(source, desct, metadata){
            //  console.log('On change!')
            
        }
        function onMove(source, desct, capturedPiece){
            //  console.log('On move!')
        }
      
        async function onAfterMove(source, desct, metadata){
            console.log('onAfterMove')
            // Promotion logic
            var destRow = desct.substr(1,1)
            var promotedPiece = ''
            var movedPieceIsPawn = game.get(source).type == 'p'
            if(movedPieceIsPawn && (destRow == '8' || destRow == '1')){
                promotedPiece = getPromotedPiece()
            }
            desct = desct + promotedPiece

            // Checking if move is legal
            if (!checkLegality(source, desct, metadata)){
                return false
            }

            config.turnColor =  game.turn() == 'w' ? 'white' : 'black'
            config.movable.color = config.turnColor
            fen = game.fen()
            config.fen = fen
            ground.set(config)
            var nextMove = moves.shift()
            console.log(source+desct +' --- ' + nextMove)
            if (source+desct == nextMove || game.game_over()){
                if (moves.length == 0){
                    console.log('WIN')
                    score += 1
                    $score.html(score)
                    setTimeout(1300)
                    await initGame()
                    ground.redrawAll()
                }
                else if (moves.length > 0){
                    console.log('next move')
                    movePiece(moves.shift())
                }
            } 
            else{
                resetGui()
            }
        }

        function movePiece(uci){
            var start = uci.substr(0,2)
            var end  = uci.substr(2,2)
            var promotion = uci.substr(4,1)
            var game_move = {from: start, to: end, promotion: promotion}
            
            ground.move(start, end)
            var move = game.move({
                from: start,
                to: end,
                promotion: promotion})

            fen = game.fen()
            config.fen = fen
            ground.set(config)
            config.turnColor =  game.turn() == 'w' ? 'white' : 'black'
            config.movable.color = config.turnColor
            ground.set(config)
            playMoveSound(move, move.captured)
        }

        function resetGui(){
            console.log('RESET')
            score = 0
            $score.html(score)
        }
        config.movable = {
                free: true,
                events: {
                    after: onAfterMove
                }
            }
        config.events ={
                change: onChange,
                move: onMove,
                select: onSelect,
                insert: onInsert,
                dropNewPiece: ondropNewPiece,
                afterNewPiece: onafterNewPiece
            } 
        fen = game.fen()
        config.fen = fen
        ground.set(config)
        
        const element = document.getElementById("reset");
        element.addEventListener("click", function() {
            initGame()
            ground.redrawAll()
            resetGui()
        });

        document.getElementById('sizeRange').oninput = function(){resizeBoard()}; 
        
        function getPromotedPiece(){
           return   confirm('You want a queen?') ? 'q' :
                        confirm('You want a rook?') ? 'r' :
                            confirm('You want a horsey?') ? 'n' : 
                                confirm('You want a bisop?') ? 'b' 
                                    : 'q' 
        }

        function resizeBoard(){
            var newSize = document.getElementById('sizeRange').value
            console.log(newSize)
            document.getElementById('chessground').style.height = newSize + 'px'
            document.getElementById('chessground').style.width = newSize  + 'px'
        }

        function setIdGui(){
            var userid = getCookie("UserId")
            console.log('current user is: '+userid)
            if (userid == ''){
                userIdNotSet()
                return
            }
            userIdIsSet(userid)
        }

        function userIdIsSet(textValue){
            document.getElementById("idTextField").placeholder = "Logged in as: " + textValue
        }

        function userIdNotSet(){
            document.getElementById("idTextField").placeholder = 'Enter login here'
        }

        document.getElementById('idButton').addEventListener("click", function(){
            var textFieldValue = document.getElementById("idTextField").value
            if (!(textFieldValue.trim() === '')){ // string empty or whitespace
                setCookie("UserId", textFieldValue, 30)
                document.getElementById("idTextField").value = ''
                userIdIsSet(textFieldValue)
            } else{
                var placeholderDefault =  document.getElementById("idTextField").placeholder == "Enter login here"
                if (!placeholderDefault && confirm('Wanna logout, kiddo?')){
                    setCookie("UserId", null, -1)
                    userIdNotSet()
                }
            }
        }) 

    </script>
</head>
    <div id="chessground"></div>
    <span>Score is: <span id="score">0</span></span>
    <button id="reset">Restart</button>
    <div class="slidecontainer" >
    <input autocomplete="off" type="range" min="400" max="1200" value="700" class="slider" id="sizeRange">
    </div>
    
    <div style="display: inline-flex;">
        <input autocomplete="off" id="idTextField" type="text" placeholder="Enter login here">
        <button style="margin-left: 10px" id="idButton">Login</button>
    </div>
</body>
</html>